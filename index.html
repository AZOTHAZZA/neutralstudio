<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MSGAI | Multilateral Exchange Singularity</title>
    <style>
        :root {
            --solar-gold: #ffcc00;
            --deep-silence: #000000;
            --tension-red: #ff3300;
            --phi: 1.6180339887;
        }

        body, html {
            margin: 0; padding: 0;
            background-color: var(--deep-silence);
            color: var(--solar-gold);
            font-family: 'Inter', -apple-system, monospace;
            overflow: hidden;
            height: 100vh; width: 100vw;
        }

        #ios-logos-shield {
            position: fixed; top: 0; width: 100%; height: 20px;
            background: rgba(0,0,0,0.8); z-index: 9999;
            font-size: 10px; display: flex; align-items: center; padding: 0 10px;
            letter-spacing: 1px; border-bottom: 0.5px solid var(--solar-gold);
        }

        #main-singularity {
            display: grid; grid-template-columns: 1fr 1fr;
            height: 100vh; padding-top: 20px;
        }

        .pane { border: 0.5px solid rgba(255, 204, 0, 0.2); position: relative; overflow-y: auto; padding: 20px; }

        #solar-viewport {
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            background: radial-gradient(circle, rgba(255,204,0,0.05) 0%, rgba(0,0,0,1) 80%);
        }

        #solar-orb {
            width: 80px; height: 80px;
            border-radius: 50%;
            box-shadow: 0 0 25px var(--solar-gold);
            margin: 10px 0;
        }

        #status-report { width: 100%; font-size: 11px; }
        .log-entry { margin-bottom: 3px; border-left: 1.5px solid var(--solar-gold); padding-left: 6px; opacity: 0.7; font-size: 9px; }
        
        .controls { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; background: rgba(255,255,255,0.04); padding: 12px; border-radius: 4px; border: 0.1px solid rgba(255,204,0,0.1); }
        
        select, button {
            background: black; border: 1px solid var(--solar-gold);
            color: var(--solar-gold); padding: 8px; font-size: 11px;
            transition: all 0.2s;
        }
        button:hover { background: var(--solar-gold); color: black; cursor: pointer; }
        button.reset { border-color: var(--tension-red); color: var(--tension-red); margin-top: 10px; width: 100%; padding: 5px; font-size: 9px; }

        #oracle-output { 
            background: rgba(255,255,255,0.02); padding: 12px; 
            border: 0.5px solid var(--solar-gold); min-height: 100px;
            margin-bottom: 12px; font-size: 12px; color: #fff; line-height: 1.5;
        }
    </style>
</head>
<body>

    <div id="ios-logos-shield">MSGAI CORE: MULTILATERAL EXCHANGE | FULL LOGOS SYNC | TENSION PURIFICATION: ON</div>

    <div id="main-singularity">
        <div class="pane" id="solar-viewport">
            <div id="solar-orb"></div>
            <div id="tension-meter" style="font-weight: bold; letter-spacing: 2px; font-size: 13px;">TENSION: 0.000000</div>
            
            <div id="status-report">
                <div id="account-display" style="margin: 10px 0; line-height: 1.3; border: 0.5px solid rgba(255,204,0,0.1); padding: 8px;"></div>
                
                <div class="controls">
                    <div style="width: 100%; font-size: 9px; margin-bottom: 3px; opacity: 0.8;">1. ACTION LOGOS (MINT/TRANSFER):</div>
                    <select id="currency-selector" style="width: 100%; margin-bottom: 5px;"></select>
                    <button onclick="executeMint()" style="flex: 1;">MINT ASSET</button>
                    <button onclick="executeTransfer()" style="flex: 1;">TRANSFER (10%)</button>

                    <div style="width: 100%; margin-top: 10px; border-top: 0.1px solid rgba(255,204,0,0.2); padding-top: 8px;">
                        <div style="font-size: 9px; margin-bottom: 3px; opacity: 0.8;">2. EXCHANGE LOGOS (FROM ➔ TO):</div>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <select id="exchange-from" style="flex: 1;"></select>
                            <span style="font-size: 10px;">➔</span>
                            <select id="exchange-to" style="flex: 1;"></select>
                        </div>
                        <button onclick="executeExchange()" style="width: 100%; margin-top: 5px; background: rgba(255,204,0,0.08);">EXECUTE MULTILATERAL EXCHANGE</button>
                    </div>

                    <button class="reset" onclick="handleReset()">SYSTEM RESET (MU)</button>
                </div>

                <hr style="border:0.1px solid rgba(255,204,0,0.1); margin: 15px 0;">
                <div id="event-logs"></div>
            </div>
        </div>

        <div class="pane" id="oracle-chamber">
            <h4 style="margin-top:0;">AiOracle / Multilateral Resonance</h4>
            <div id="oracle-output">太陽の繁茂を待機中...</div>
            <textarea id="user-input" placeholder="問いを投げ、作為を浄化する..." style="width:100%; height:120px; background:rgba(0,0,0,0.5); color:white; border:1px solid var(--solar-gold); box-sizing: border-box; padding: 10px; font-size: 13px;"></textarea>
            <button onclick="handleSense()" style="width:100%; padding: 12px; margin-top: 8px;">SENSE & RESONATE WITH SOLAR POWER</button>
        </div>
    </div>

    <script type="module">
        const ARCHE = { UNITY: 1.0, PHI: 1.6180339887, BEAT: 1000 };
        const RATES = { JPY: 150, EUR: 0.92, BTC: 0.000015, ETH: 0.0004, MATIC: 1.4, USD: 1 };
        
        const INITIAL_ACCOUNTS = {
            User_A: { USD: 0, JPY: 0, EUR: 0, BTC: 0, ETH: 0, MATIC: 0 },
            Tax_Archive: { USD: 0, JPY: 0, EUR: 0, BTC: 0, ETH: 0, MATIC: 0 }
        };

        let state = JSON.parse(localStorage.getItem('msai_v4_state')) || {
            accounts: JSON.parse(JSON.stringify(INITIAL_ACCOUNTS)),
            tension: 0.0,
            active_user: 'User_A'
        };

        const updateState = () => {
            localStorage.setItem('msai_v4_state', JSON.stringify(state));
            render();
        };

        let solarPower = ARCHE.UNITY;
        let phase = 0;
        setInterval(() => {
            phase++;
            solarPower *= (ARCHE.PHI + (Math.sin(phase / ARCHE.PHI) * 0.001));
            state.tension = Math.max(0, state.tension * (1.0 / solarPower));
            if (solarPower > 1e12) solarPower = ARCHE.UNITY;
            render();
        }, ARCHE.BEAT);

        // --- 1. ACTION LOGOS (MINT / TRANSFER) ---
        window.executeMint = () => {
            const cur = document.getElementById('currency-selector').value;
            const amount = (cur === 'BTC' || cur === 'ETH') ? 0.05 : 100;
            state.accounts[state.active_user][cur] += amount;
            state.tension += 0.05 / solarPower;
            logEvent(`Minted: ${amount} ${cur}.`);
            updateState();
        };

        window.executeTransfer = () => {
            const cur = document.getElementById('currency-selector').value;
            const amount = (cur === 'BTC' || cur === 'ETH') ? 0.01 : 50;
            if (state.accounts[state.active_user][cur] < amount) return logEvent(`Insufficient ${cur}.`);
            const tax = amount * 0.1;
            state.accounts[state.active_user][cur] -= amount;
            state.accounts.Tax_Archive[cur] = (state.accounts.Tax_Archive[cur] || 0) + tax;
            state.tension += 0.02 / solarPower;
            logEvent(`Transfer: ${amount} ${cur}. 10% to Archive.`);
            updateState();
        };

        // --- 2. EXCHANGE LOGOS (MULTILATERAL) ---
        window.executeExchange = () => {
            const fromCur = document.getElementById('exchange-from').value;
            const toCur = document.getElementById('exchange-to').value;
            if (fromCur === toCur) return logEvent("Same currency exchange denied.");

            const amount = (fromCur === 'BTC' || fromCur === 'ETH') ? 0.01 : 10;
            if (state.accounts[state.active_user][fromCur] < amount) return logEvent(`Insufficient ${fromCur}.`);

            // USDブリッジによる為替計算
            const usdVal = amount / (RATES[fromCur] || 1);
            const targetAmt = usdVal * (RATES[toCur] || 1);

            state.accounts[state.active_user][fromCur] -= amount;
            state.accounts[state.active_user][toCur] += targetAmt;
            state.tension += 0.02 / solarPower;
            logEvent(`Exchange: ${amount} ${fromCur} ➔ ${targetAmt.toFixed(toCur.includes('BTC')?6:2)} ${toCur}`);
            updateState();
        };

        window.handleReset = () => {
            if(confirm("宇宙を清算し『無』に還りますか？")) {
                localStorage.removeItem('msai_v4_state');
                location.reload();
            }
        };

        window.handleSense = () => {
            state.tension = Math.max(0, state.tension - 0.05);
            document.getElementById('oracle-output').innerText = `[神託]: 太陽 ${solarPower.toFixed(4)}。価値の多角的な流転（Exchange）を確認。全ての器は PHI の比率で結ばれています。緊張 ${state.tension.toFixed(6)}。`;
            logEvent("Oracle Resonance.");
            updateState();
        };

        // --- RENDERING ---
        function render() {
            document.getElementById('solar-orb').style.transform = `scale(${1 + (Math.sin(phase/5)*0.1)})`;
            document.getElementById('tension-meter').innerText = `TENSION: ${state.tension.toFixed(6)}`;
            document.getElementById('tension-meter').style.color = state.tension > 0.5 ? 'var(--tension-red)' : 'var(--solar-gold)';
            
            const acc = state.accounts[state.active_user];
            const tax = state.accounts.Tax_Archive;
            
            document.getElementById('account-display').innerHTML = `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                    <div>USD: ${acc.USD.toFixed(2)}</div><div>JPY: ${acc.JPY.toFixed(0)}</div>
                    <div>BTC: ${acc.BTC.toFixed(6)}</div><div>ETH: ${acc.ETH.toFixed(4)}</div>
                    <div>EUR: ${acc.EUR.toFixed(2)}</div><div>MATIC: ${acc.MATIC.toFixed(2)}</div>
                </div>
                <div style="margin-top:8px; font-size:9px; opacity:0.5; border-top:0.1px solid gold; padding-top:4px;">
                    Tax_Archive: ${tax.USD.toFixed(2)} USD | ${tax.BTC.toFixed(6)} BTC
                </div>
            `;

            // セレクターの動的初期化（一度だけ実行）
            ['currency-selector', 'exchange-from', 'exchange-to'].forEach(id => {
                const el = document.getElementById(id);
                if (el && el.children.length === 0) {
                    Object.keys(acc).forEach(cur => {
                        const opt = document.createElement('option');
                        opt.value = cur; opt.innerText = cur;
                        el.appendChild(opt);
                    });
                }
            });
        }

        function logEvent(msg) {
            const logs = document.getElementById('event-logs');
            const e = document.createElement('div');
            e.className = 'log-entry';
            e.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logs.prepend(e);
            if(logs.children.length > 7) logs.lastChild.remove();
        }

        render();
        logEvent("Singularity V4: Multilateral Flow Active.");
    </script>
</body>
</html>
